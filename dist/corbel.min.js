!function(root,factory){"use strict";"function"==typeof define&&define.amd?define([],function(){return factory(root)}):"undefined"!=typeof module&&module.exports?module.exports=factory.call(root,root,process||void 0):void 0!==root&&(root.corbel=factory(root))}(this,function(root,process){"use strict";function Config(config){config=config||{},this.config={},corbel.utils.extend(this.config,config)}var corbel={};!function(){function CorbelDriver(config,events){events&&"object"==typeof events?this._events=corbel.utils.clone(events):this._events={},this.guid=corbel.utils.guid(),this.config=corbel.Config.create(config),this.iam=corbel.Iam.create(this),this.resources=corbel.Resources.create(this),this.assets=corbel.Assets.create(this),this.oauth=corbel.Oauth.create(this),this.notifications=corbel.Notifications.create(this),this.ec=corbel.Ec.create(this),this.evci=corbel.Evci.create(this),this.borrow=corbel.Borrow.create(this),this.composr=corbel.CompoSR.create(this),this.scheduler=corbel.Scheduler.create(this),this.webfs=corbel.Webfs.create(this),this.domain=corbel.Domain.create(this)}CorbelDriver.prototype.clone=function(){return new CorbelDriver(this.config.getConfig(),this._events)},CorbelDriver.prototype.addEventListener=function(name,fn){if("function"!=typeof fn)throw new Error("corbel:error:invalid:type");this._events[name]=this._events[name]||[],this._events[name].indexOf(fn)===-1&&this._events[name].push(fn)},CorbelDriver.prototype.removeEventListener=function(name,fn){if(this._events[name]){var index=this._events[name].indexOf(fn);index!==-1&&this._events[name].splice(index,1)}},CorbelDriver.prototype.dispatch=function(name,options){this._events[name]&&this._events[name].length&&this._events[name].forEach(function(fn){fn(options)})},CorbelDriver.prototype.on=CorbelDriver.prototype.addEventListener,CorbelDriver.prototype.off=CorbelDriver.prototype.removeEventListener,CorbelDriver.prototype.trigger=CorbelDriver.prototype.dispatch,corbel.CorbelDriver=CorbelDriver,corbel.getDriver=function(config){if(config=config||{},!config.urlBase)throw new Error("error:undefined:urlbase");return new CorbelDriver(config)}}(),function(){var utils=corbel.utils={};return utils.extend=function(obj){return Array.prototype.slice.call(arguments,1).forEach(function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj},utils.inherit=function(prototypeProperties,staticProperties){var child,parent=this;child=prototypeProperties&&prototypeProperties.hasOwnProperty("constructor")?prototypeProperties.constructor:function(){return parent.apply(this,arguments)},utils.extend(child,parent,staticProperties);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,prototypeProperties&&utils.extend(child.prototype,prototypeProperties),child.__super__=parent.prototype,child},utils.guid=function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()},utils.reload=function(){void 0!==window&&window.location.reload()},utils.param=function(obj){var str=[];for(var p in obj)obj.hasOwnProperty(p)&&str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},utils.toURLEncoded=function(obj){var str=[];for(var p in obj)obj.hasOwnProperty(p)&&str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},utils.serializeParams=function(params){function getJsonEncodedStringify(param){return encodeURIComponent(JSON.stringify(param))}function queryObjectToString(params,key){var query,result="";params.queryDomain=params.queryDomain||"api",result+=params.queryDomain+":"+key+"=";try{return query="string"==typeof params[key]?JSON.parse(params[key]):JSON.parse(JSON.stringify(params[key])),result+=getJsonEncodedStringify(query)}catch(e){return result+params[key]}}var result="";if(void 0===params||null===params)return result;if(!(params instanceof Object)&&"object"!=typeof params)throw new Error("expected params to be an Object type, but got "+typeof params);return params.aggregation&&(result="api:aggregation="+getJsonEncodedStringify(params.aggregation)),params.query&&(params.queryDomain=params.queryDomain||"api",result+=result?"&":"",result+=queryObjectToString(params,"query")),params.queries&&params.queries.forEach(function(query){result+=result?"&":"",result+=queryObjectToString(query,"query")}),params.condition&&(params.queryDomain=params.queryDomain||"api",result+=result?"&":"",result+=queryObjectToString(params,"condition")),params.conditions&&params.conditions.forEach(function(condition){result+=result?"&":"",result+=queryObjectToString(condition,"condition")}),params.search&&(result+=result?"&":"",result+="api:search=",result+=params.search instanceof Object?getJsonEncodedStringify(params.search):encodeURIComponent(params.search),params.hasOwnProperty("indexFieldsOnly")&&(result+="&api:indexFieldsOnly="+getJsonEncodedStringify(params.indexFieldsOnly))),params.distinct&&(result+=result?"&":"",result+="api:distinct="+encodeURIComponent(params.distinct instanceof Array?params.distinct.join(","):params.distinct)),params.distinctfield&&(result+=result?"&":"",result+="api:distinctfield="+encodeURIComponent(params.distinctfield instanceof Array?params.distinctfield.join(","):params.distinctfield)),params.sort&&(result+=result?"&":"",result+="api:sort="+getJsonEncodedStringify(params.sort)),params.pagination&&((params.pagination.page||0===params.pagination.page)&&(result+=result?"&":"",result+="api:page="+params.pagination.page),(params.pagination.pageSize||0===params.pagination.pageSize)&&(result+=result?"&":"",result+="api:pageSize="+params.pagination.pageSize)),params.customQueryParams&&Object.keys(params.customQueryParams).forEach(function(param){result+=result?"&":"",result+=param+"="+encodeURIComponent(params.customQueryParams[param])}),result},utils.defaults=function(destiny,defaults){return Object.keys(defaults).forEach(function(key){"undefined"==typeof destiny[key]&&(destiny[key]=defaults[key])}),destiny},utils.pick=function(object,keys){var destiny={};return keys.forEach(function(key){destiny[key]=object[key]}),destiny},utils.clone=function clone(item){if(!item)return item;var result,types=[Number,String,Boolean];if(types.forEach(function(type){item instanceof type&&(result=type(item))}),"undefined"==typeof result)if("[object Array]"===Object.prototype.toString.call(item))result=[],item.forEach(function(child,index){result[index]=clone(child)});else if("object"==typeof item)if(item.nodeType&&"function"==typeof item.cloneNode)result=item.cloneNode(!0);else if(item.prototype)result=item;else if(item instanceof Date)result=new Date(item);else{result={};for(var i in item)result[i]=clone(item[i])}else result=item;return result},utils.keysToLowerCase=function(obj){if(void 0===obj||null===obj)return obj;for(var key,keys=Object.keys(obj),n=keys.length,newobj={};n--;)key=keys[n],newobj[key.toLowerCase()]=obj[key];return newobj},utils.isJSON=function(string){try{JSON.parse(string)}catch(e){return!1}return!0},utils.isStream=function(data){return!(!data.pipe||"function"!=typeof data.pipe)},utils.arrayToObject=function(array){var object={};return array.map(function(element,index){object[index]=element}),object},utils.copyArray=function(list){for(var newList=new Array(list.length),i=list.length;i--;)newList[i]=list[i];return newList},utils.dataURItoBlob=function(dataURI){var serialize;serialize=corbel.Config.isNode||!root.atob?require("base-64").decode:root.atob;var BlobBuilder,BlobConstructor;corbel.Config.isBrowser&&(BlobBuilder=window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,BlobConstructor=window.Blob);for(var byteString=serialize(dataURI.split(",")[1]),mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],arrayBuffer=new ArrayBuffer(byteString.length),_ia=new Uint8Array(arrayBuffer),i=0;i<byteString.length;i++)_ia[i]=byteString.charCodeAt(i);var blob;return BlobBuilder?(blob=new BlobBuilder,blob.append(arrayBuffer),blob=blob.getBlob(mimeString)):blob=new BlobConstructor([_ia],{type:mimeString}),blob},utils.isInTime=function(driver,maxDelay){var MAX_TIME_DELTA=600,checkDelay=function(response){var local=new Date,server=new Date(response.headers.date),delay=Math.abs(local.valueOf()-server.valueOf());if(delay>maxDelay)throw new Error("error:client-time:delay");return delay};return maxDelay=1e3*(maxDelay||MAX_TIME_DELTA),corbel.request.send({url:driver.config.getCurrentEndpoint("iam").replace(/v\d.\d\//,"")+"version",method:corbel.request.method.OPTIONS}).then(function(response){return checkDelay(response)})["catch"](function(error){if(0===error.data.length)throw new Error("error:server:not-available");throw error})},utils}(),function(){corbel.validate={},corbel.validate.values=function(keys,obj){var that=this;return keys.forEach(function(key){that.value(key,obj[key])}),!0},corbel.validate.value=function(key,value){return this.isDefined(value,key+" value is mandatory and cannot be undefined")},corbel.validate.isDefined=function(value,message){var isUndefined=void 0===value;if(isUndefined&&message)throw new Error(message);return!isUndefined},corbel.validate.failIfIsDefined=function(value,message){var isDefined=void 0!==value;if(isDefined&&message)throw new Error(message);return!isDefined},corbel.validate.isNotNull=function(value,message){var isNull=null===value;if(isNull&&message)throw new Error(message);return!isNull},corbel.validate.isValue=function(value,message){return this.isDefined(value,message)&&this.isNotNull(value,message)},corbel.validate.isObject=function(obj){return"object"==typeof obj},corbel.validate.isGreaterThan=function(value,greaterThan,message){var gt=this.isValue(value)&&value>greaterThan;if(!gt&&message)throw new Error(message);return gt},corbel.validate.isGreaterThanOrEqual=function(value,isGreaterThanOrEqual,message){var gte=this.isValue(value)&&value>=isGreaterThanOrEqual;if(!gte&&message)throw new Error(message);return gte}}(),function(){return corbel.Object=function(){return this},corbel.Object.inherit=corbel.utils.inherit,corbel.Object}(),function(){corbel.cryptography=function(){function b64_hmac_sha256(k,d){return rstr2b64(rstr_hmac_sha256(str2rstr_utf8(k),str2rstr_utf8(d)))}function rstr_hmac_sha256(key,data){var bkey=rstr2binb(key);bkey.length>16&&(bkey=binb_sha256(bkey,8*key.length));for(var ipad=Array(16),opad=Array(16),i=0;i<16;i++)ipad[i]=909522486^bkey[i],opad[i]=1549556828^bkey[i];var hash=binb_sha256(ipad.concat(rstr2binb(data)),512+8*data.length);return binb2rstr(binb_sha256(opad.concat(hash),768))}function rstr2b64(input){try{}catch(e){b64pad=""}for(var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",output="",len=input.length,i=0;i<len;i+=3)for(var triplet=input.charCodeAt(i)<<16|(i+1<len?input.charCodeAt(i+1)<<8:0)|(i+2<len?input.charCodeAt(i+2):0),j=0;j<4;j++)output+=8*i+6*j>8*input.length?b64pad:tab.charAt(triplet>>>6*(3-j)&63);return output}function str2rstr_utf8(input){for(var x,y,output="",i=-1;++i<input.length;)x=input.charCodeAt(i),y=i+1<input.length?input.charCodeAt(i+1):0,55296<=x&&x<=56319&&56320<=y&&y<=57343&&(x=65536+((1023&x)<<10)+(1023&y),i++),x<=127?output+=String.fromCharCode(x):x<=2047?output+=String.fromCharCode(192|x>>>6&31,128|63&x):x<=65535?output+=String.fromCharCode(224|x>>>12&15,128|x>>>6&63,128|63&x):x<=2097151&&(output+=String.fromCharCode(240|x>>>18&7,128|x>>>12&63,128|x>>>6&63,128|63&x));return output}function rstr2binb(input){for(var output=Array(input.length>>2),i=0;i<output.length;i++)output[i]=0;for(var i=0;i<8*input.length;i+=8)output[i>>5]|=(255&input.charCodeAt(i/8))<<24-i%32;return output}function binb2rstr(input){for(var output="",i=0;i<32*input.length;i+=8)output+=String.fromCharCode(input[i>>5]>>>24-i%32&255);return output}function sha256_S(X,n){return X>>>n|X<<32-n}function sha256_R(X,n){return X>>>n}function sha256_Ch(x,y,z){return x&y^~x&z}function sha256_Maj(x,y,z){return x&y^x&z^y&z}function sha256_Sigma0256(x){return sha256_S(x,2)^sha256_S(x,13)^sha256_S(x,22)}function sha256_Sigma1256(x){return sha256_S(x,6)^sha256_S(x,11)^sha256_S(x,25)}function sha256_Gamma0256(x){return sha256_S(x,7)^sha256_S(x,18)^sha256_R(x,3)}function sha256_Gamma1256(x){return sha256_S(x,17)^sha256_S(x,19)^sha256_R(x,10)}function binb_sha256(m,l){var a,b,c,d,e,f,g,h,i,j,T1,T2,HASH=new Array(1779033703,(-1150833019),1013904242,(-1521486534),1359893119,(-1694144372),528734635,1541459225),W=new Array(64);for(m[l>>5]|=128<<24-l%32,m[(l+64>>9<<4)+15]=l,i=0;i<m.length;i+=16){for(a=HASH[0],b=HASH[1],c=HASH[2],d=HASH[3],e=HASH[4],f=HASH[5],g=HASH[6],h=HASH[7],j=0;j<64;j++)j<16?W[j]=m[j+i]:W[j]=safe_add(safe_add(safe_add(sha256_Gamma1256(W[j-2]),W[j-7]),sha256_Gamma0256(W[j-15])),W[j-16]),T1=safe_add(safe_add(safe_add(safe_add(h,sha256_Sigma1256(e)),sha256_Ch(e,f,g)),sha256_K[j]),W[j]),T2=safe_add(sha256_Sigma0256(a),sha256_Maj(a,b,c)),h=g,g=f,f=e,e=safe_add(d,T1),d=c,c=b,b=a,a=safe_add(T1,T2);HASH[0]=safe_add(a,HASH[0]),HASH[1]=safe_add(b,HASH[1]),HASH[2]=safe_add(c,HASH[2]),HASH[3]=safe_add(d,HASH[3]),HASH[4]=safe_add(e,HASH[4]),HASH[5]=safe_add(f,HASH[5]),HASH[6]=safe_add(g,HASH[6]),HASH[7]=safe_add(h,HASH[7])}return HASH}function safe_add(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function b64tob64u(s){return s=s.replace(/\=/g,""),s=s.replace(/\+/g,"-"),s=s.replace(/\//g,"_")}var b64pad="",sha256_K=new Array(1116352408,1899447441,(-1245643825),(-373957723),961987163,1508970993,(-1841331548),(-1424204075),(-670586216),310598401,607225278,1426881987,1925078388,(-2132889090),(-1680079193),(-1046744716),(-459576895),(-272742522),264347078,604807628,770255983,1249150122,1555081692,1996064986,(-1740746414),(-1473132947),(-1341970488),(-1084653625),(-958395405),(-710438585),113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,(-2117940946),(-1838011259),(-1564481375),(-1474664885),(-1035236496),(-949202525),(-778901479),(-694614492),(-200395387),275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,(-2067236844),(-1933114872),(-1866530822),(-1538233109),(-1090935817),(-965641998));return{rstr2b64:rstr2b64,str2rstr_utf8:str2rstr_utf8,b64_hmac_sha256:b64_hmac_sha256,b64tob64u:b64tob64u}}()}(),function(){var jwt=corbel.jwt={EXPIRATION:3500,ALGORITHM:"HS256",TYP:"JWT",VERSION:"1.0.0",generate:function(claims,secret,alg){if(claims=claims||{},claims.exp=claims.exp||jwt._generateExp(),!claims.iss)throw new Error("jwt:undefined:iss");if(!claims.aud)throw new Error("jwt:undefined:aud");return jwt._generate(claims,secret,alg)},_generate:function(claims,secret,alg){alg=alg||jwt.ALGORITHM;var claimsKeys=["iss","aud","exp","scope","prn","version","refresh_token","request_domain","basic_auth.username","basic_auth.password","device_id"],finalClaims={};claimsKeys.forEach(function(key){claims[key]&&(finalClaims[key]=claims[key])}),corbel.utils.extend(finalClaims,claims),Array.isArray(finalClaims.scope)&&(finalClaims.scope=finalClaims.scope.join(" "));var bAlg=corbel.cryptography.rstr2b64(corbel.cryptography.str2rstr_utf8(JSON.stringify({typ:jwt.TYP,alg:alg}))),bClaims=corbel.cryptography.rstr2b64(corbel.cryptography.str2rstr_utf8(JSON.stringify(finalClaims))),segment=bAlg+"."+bClaims,assertion=corbel.cryptography.b64tob64u(corbel.cryptography.b64_hmac_sha256(secret,segment));return segment+"."+assertion},_generateExp:function(){return Math.round((new Date).getTime()/1e3)+jwt.EXPIRATION},decode:function(assertion){var serialize;serialize=corbel.Config.isNode||!root.atob?require("base-64").decode:root.atob;var decoded=assertion.split(".");try{decoded[0]=JSON.parse(serialize(decoded[0]))}catch(e){decoded[0]=!1}try{decoded[1]=JSON.parse(serialize(decoded[1]))}catch(e){decoded[1]=!1}if(!decoded[0]&&!decoded[1])throw new Error("corbel:jwt:decode:invalid_assertion");return decoded[0]=decoded[0]||{},decoded[1]=decoded[1]||{},Object.keys(decoded[1]).forEach(function(key){decoded[0][key]=decoded[1][key]}),decoded[0]}};return jwt}(),function(){function doRequest(module,params,resolver){corbel.Config.isBrowser?request._browserAjax.call(module,params,resolver):request._nodeAjax.call(module,params,resolver)}var request=corbel.request={method:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",OPTIONS:"OPTIONS",PATCH:"PATCH",HEAD:"HEAD"}};request.serializeHandlers={json:function(data,cb){cb("string"!=typeof data?JSON.stringify(data):data)},"form-urlencoded":function(data,cb){cb(corbel.utils.toURLEncoded(data))},dataURI:function(data,cb){cb(corbel.Config.isNode?corbel.utils.toURLEncoded(data):corbel.utils.dataURItoBlob(data))},blob:function(data,cb){if(data instanceof ArrayBuffer)throw new Error("ArrayBuffer is not supported, please use Blob");cb(data)},stream:function(data,cb){if(data instanceof ArrayBuffer)throw new Error("ArrayBuffer is not supported, please use Blob, File, Stream or ArrayBufferView");cb(data)}},request.serialize=function(data,contentType,cb){var contentTypeSerializable=Object.keys(request.serializeHandlers).filter(function(type){if(contentType.indexOf(type)!==-1)return type});contentTypeSerializable.length>0?request.serializeHandlers[contentTypeSerializable[0]](data,cb):cb(data)},request.parseHandlers={json:function(data){return data=data||"{}","string"==typeof data&&(data=JSON.parse(data)),data}},request.parse=function(data,responseType,dataType){var parsed;return Object.keys(request.parseHandlers).forEach(function(type){responseType&&responseType.indexOf(type)!==-1&&(parsed=request.parseHandlers[type](data,dataType))}),parsed=parsed||data},request.send=function(options,driver){options=options||{};var module=this;if(!options.url)throw new Error("undefined:url");if("string"!=typeof options.url)throw new Error("invalid:url",options.url);options.withCredentials="boolean"!=typeof options.withCredentials||options.withCredentials;var params={method:options.method||request.method.GET,url:options.url,headers:"object"==typeof options.headers?options.headers:{},callbackSuccess:options.success&&"function"==typeof options.success?options.success:void 0,callbackError:options.error&&"function"==typeof options.error?options.error:void 0,responseType:options.responseType,withCredentials:options.withCredentials,useCookies:options.useCookies||!1};params=rewriteRequestToPostIfUrlLengthIsTooLarge(options,params),params.headers["content-type"]=options.contentType||"application/json";var resolver,dataMethods=[request.method.PUT,request.method.POST,request.method.PATCH],promise=new Promise(function(resolve,reject){resolver={resolve:resolve,reject:reject},driver&&driver.trigger("request",params)});return dataMethods.indexOf(params.method)!==-1?request.serialize(options.data,params.headers["content-type"],function(serialized){params.data=serialized,doRequest(module,params,resolver)}):doRequest(module,params,resolver),promise};var xhrSuccessStatus={0:200,1223:204},processResponse=function(response,resolver,callbackSuccess,callbackError){var promiseResponse,statusCode=xhrSuccessStatus[response.status]||response.status,statusType=Number(response.status.toString()[0]),data=response.response,headers=corbel.utils.keysToLowerCase(response.headers);if(statusType<=3&&!response.error)response.response&&(data=request.parse(response.response,response.responseType,response.dataType)),callbackSuccess&&callbackSuccess.call(this,data,statusCode,response.responseObject,headers),promiseResponse={data:data,status:statusCode,headers:headers},promiseResponse[response.responseObjectType]=response.responseObject,resolver.resolve(promiseResponse);else{var disconnected=response.error&&0===response.status;statusCode=disconnected?0:statusCode,callbackError&&callbackError.call(this,response.error,statusCode,response.responseObject,headers),response.response&&(data=request.parse(response.response,response.responseType,response.dataType)),promiseResponse={data:data,status:statusCode,error:response.error,headers:headers},promiseResponse[response.responseObjectType]=response.responseObject,resolver.reject(promiseResponse)}},rewriteRequestToPostIfUrlLengthIsTooLarge=function(options,params){var AUTOMATIC_HTTP_METHOD_OVERRIDE=corbel.Config.AUTOMATIC_HTTP_METHOD_OVERRIDE||!0,HTTP_METHOD_OVERRIDE_WITH_URL_SIZE_BIGGER_THAN=corbel.Config.HTTP_METHOD_OVERRIDE_WITH_URL_SIZE_BIGGER_THAN||2048;if(AUTOMATIC_HTTP_METHOD_OVERRIDE&&params.method===request.method.GET&&params.url.length>HTTP_METHOD_OVERRIDE_WITH_URL_SIZE_BIGGER_THAN){var url=params.url.split("?");params.method=request.method.POST,params.headers["X-HTTP-Method-Override"]=request.method.GET,params.url=url[0],options.data=encodeUrlToForm(url[1]),options.contentType="application/x-www-form-urlencoded"}return params},encodeUrlToForm=function(url){var form={};return url.split("&").forEach(function(formEntry){var formPair=formEntry.split("=");form[formPair[0]]=formPair[1]}),form};return request._getNodeRequestAjax=function(params){var requestAjax=require("request");return request.isCrossDomain(params.url)&&params.withCredentials&&params.useCookies&&(requestAjax=requestAjax.defaults({jar:!0})),requestAjax},request._getNodeRequestCallback=function(context,params,resolver){return function(error,response,body){var responseType,status;error?(responseType=void 0,status=0):(responseType=response.responseType||response.headers["content-type"],status=response.statusCode),processResponse.call(context,{responseObject:response,dataType:params.dataType,responseType:responseType,response:body,status:status,headers:response?response.headers:{},responseObjectType:"response",error:error},resolver,params.callbackSuccess,params.callbackError)}},request._nodeAjax=function(params,resolver){var requestAjax=request._getNodeRequestAjax(params),requestOptions={method:params.method,url:params.url,headers:params.headers},data=params.data||"",callbackRequest=request._getNodeRequestCallback(this,params,resolver);corbel.utils.isStream(data)?data.pipe(requestAjax(requestOptions,callbackRequest)):(requestOptions.body=data,requestAjax(requestOptions,callbackRequest))},request.isCrossDomain=function(url){return!(!url||"string"!=typeof url||url.indexOf("http")===-1)},request._parseResponseHeaders=function(headerStr){var headers={};if(!headerStr)return headers;for(var headerPairs=headerStr.split("\r\n"),i=0;i<headerPairs.length;i++){var headerPair=headerPairs[i],index=headerPair.indexOf(": ");if(index>0){var key=headerPair.substring(0,index),val=headerPair.substring(index+2);headers[key]=val}}return headers},request._browserAjax=function(params,resolver){var httpReq=new XMLHttpRequest;httpReq.open(params.method,params.url,!0),request.isCrossDomain(params.url)&&params.withCredentials&&(httpReq.withCredentials=!0);for(var header in params.headers)params.headers.hasOwnProperty(header)&&httpReq.setRequestHeader(header,params.headers[header]);httpReq.responseType=params.responseType||httpReq.responseType,httpReq.onload=function(xhr){xhr=xhr||httpReq,xhr=xhr.target||xhr,processResponse.call(this,{responseObject:xhr,dataType:xhr.dataType,responseType:xhr.responseType||xhr.getResponseHeader("content-type"),response:xhr.response||xhr.responseText,status:xhr.status,headers:request._parseResponseHeaders(xhr.getAllResponseHeaders()),responseObjectType:"xhr",error:xhr.error},resolver,params.callbackSuccess,params.callbackError)}.bind(this),httpReq.onerror=function(xhr){xhr=xhr||httpReq,xhr=xhr.target||xhr;var error=!xhr.error||xhr.error;processResponse.call(this,{responseObject:xhr,dataType:xhr.dataType,responseType:xhr.responseType||xhr.getResponseHeader("content-type"),response:xhr.response||xhr.responseText,status:xhr.status,responseObjectType:"xhr",error:error},resolver,params.callbackSuccess,params.callbackError)}.bind(this),params.data?httpReq.send(params.data):httpReq.send()},request}(),function(){var Services=corbel.Services=corbel.Object.inherit({constructor:function(driver){this.driver=driver},request:function(args){this.driver.trigger("service:request:before",args);var that=this;return this._requestWithRetries(args).then(function(response){return that.driver.trigger("service:request:after",response),that.driver.config.set(corbel.Services._UNAUTHORIZED_NUM_RETRIES,0),response})["catch"](function(error){throw that.driver.trigger("service:request:after",error),that.driver.config.set(corbel.Services._UNAUTHORIZED_NUM_RETRIES,0),error})},_requestWithRetries:function(args){var that=this,maxRetries=corbel.Services._UNAUTHORIZED_MAX_RETRIES,requestParameters=that._buildParams(args);return that._doRequest(requestParameters)["catch"](function(response){var retries=that.driver.config.get(corbel.Services._UNAUTHORIZED_NUM_RETRIES,0);if(retries<maxRetries&&response.status===corbel.Services._UNAUTHORIZED_STATUS_CODE)return that._refreshToken().then(function(){return that.driver.config.set(corbel.Services._UNAUTHORIZED_NUM_RETRIES,retries+1),that._requestWithRetries(args)["catch"](function(retryResponse){throw response=retryResponse})})["catch"](function(){throw response});throw response})},_doRequest:function(params){var that=this;return corbel.request.send(params,that.driver).then(function(response){return that.driver.config.set(corbel.Services._FORCE_UPDATE_STATUS,0),that.driver.config.set(corbel.Services._UNAUTHORIZED_NUM_RETRIES,0),response})["catch"](function(response){if(response.status===corbel.Services._FORCE_UPDATE_STATUS_CODE&&response.textStatus===corbel.Services._FORCE_UPDATE_TEXT){var retries=that.driver.config.get(corbel.Services._FORCE_UPDATE_STATUS,0);throw retries<corbel.Services._FORCE_UPDATE_MAX_RETRIES?(retries++,that.driver.config.set(corbel.Services._FORCE_UPDATE_STATUS,retries),that.driver.trigger("force:update",response),response):response}throw response})},_refreshToken:function(){var tokenObject=this.driver.config.get(corbel.Iam.IAM_TOKEN,{});return this._refreshHandler(tokenObject)},_refreshHandler:function(tokenObject){var that=this;return this.driver._refreshHandlerPromise?this.driver._refreshHandlerPromise:(tokenObject.refreshToken?this.driver._refreshHandlerPromise=this.driver.iam.token().refresh(tokenObject.refreshToken,this.driver.config.get(corbel.Iam.IAM_TOKEN_SCOPES,"")):this.driver._refreshHandlerPromise=this.driver.iam.token().create(),this.driver._refreshHandlerPromise.then(function(response){return that.driver.trigger("token:refresh",response.data),that.driver._refreshHandlerPromise=null,response})["catch"](function(err){throw that.driver._refreshHandlerPromise=null,err}))},_addAuthorization:function(params){var accessToken=params.accessToken?params.accessToken:this.driver.config.get(corbel.Iam.IAM_TOKEN,{}).accessToken;return accessToken&&!params.headers.Authorization?(params.headers.Authorization="Bearer "+accessToken,params.withCredentials=!0):params.headers.Authorization&&(params.withCredentials=!0),params},_buildParams:function(args){var defaults={dataType:"json",contentType:"application/json; charset=utf-8",dataFilter:corbel.Services.addEmptyJson,headers:{Accept:"application/json"},method:corbel.request.method.GET},params=corbel.utils.defaults({},args);if(params=corbel.utils.defaults(params,defaults),!params.url)throw new Error("You must define an url");return params.query&&(params.url+="?"+params.query),params.noRedirect&&(params.headers["No-Redirect"]=!0),params.Accept&&(params.headers.Accept=params.Accept,params.dataType=void 0),"blob"===params.dataType&&corbel.Config.isBrowser&&(params.headers.Accept=params.data.type,params.contentType=params.data.type,params.dataType=void 0),params=this._addAuthorization(params),corbel.utils.pick(params,["url","dataType","contentType","method","headers","data","dataFilter","responseType","withCredentials","success","error"])},_buildUri:function(){var uri="";return"/"!==this.urlBase.slice(-1)&&(uri+="/"),Array.prototype.slice.call(arguments).forEach(function(argument){argument&&(uri+=argument+"/")}),uri=uri.slice(0,-1),this.urlBase+uri}},{_FORCE_UPDATE_TEXT:"unsupported_version",_FORCE_UPDATE_MAX_RETRIES:3,_FORCE_UPDATE_STATUS:"fu_r",_FORCE_UPDATE_STATUS_CODE:403,_UNAUTHORIZED_MAX_RETRIES:1,_UNAUTHORIZED_NUM_RETRIES:"un_r",_UNAUTHORIZED_STATUS_CODE:401,getLocationId:function(responseObject){var location=this._getLocationHeader(responseObject);return location?location.substr(location.lastIndexOf("/")+1):void 0},getLocation:function(responseObject){return this._getLocationHeader(responseObject)},_getLocationHeader:function(responseObject){return responseObject=responseObject||{},responseObject.xhr?responseObject.xhr.getResponseHeader("Location"):responseObject.response&&responseObject.response.headers.location?responseObject.response.headers.location:void 0},addEmptyJson:function(response,type){return response||"json"!==type||(response="{}"),response}});return Services}(),Config.URL_BASE_PLACEHOLDER="{{module}}",Config.URL_BASE_PORT_PLACEHOLDER="{{modulePort}}",corbel.Config=Config;var processExist=function(){return"undefined"!=typeof process||"[object process]"==={}.toString.call(process)};"undefined"!=typeof module&&module.exports&&processExist()&&"undefined"==typeof window?Config.__env__="browser"===process.env.NODE_ENV?"browser":"node":Config.__env__="browser",Config.isNode="node"===Config.__env__,Config.isBrowser="browser"===Config.__env__,Config.clientType=Config.isNode?"NODE":"WEB",Config.isNode||!window.location?Config.wwwRoot="localhost":Config.wwwRoot=window.location.protocol+"//"+window.location.host+window.location.pathname,Config.create=function(config){return new Config(config)},Config.prototype.getConfig=function(){return this.config},Config.prototype.setConfig=function(config){return this.config=corbel.utils.extend(this.config,config),this},Config.prototype.get=function(field,defaultValue){if(void 0===this.config[field]){if(void 0===defaultValue)throw new Error("config:undefined:"+field);return defaultValue}return this.config[field]},Config.prototype.getCurrentEndpoint=function(moduleName,port){var moduleEndpoint=moduleName+"Endpoint",endpoint=this.get(moduleEndpoint,null)?this.get(moduleEndpoint):this.get("urlBase");return endpoint=endpoint.replace(corbel.Config.URL_BASE_PLACEHOLDER,moduleName),port&&(endpoint=endpoint.replace(corbel.Config.URL_BASE_PORT_PLACEHOLDER,port)),endpoint},Config.prototype.set=function(field,value){this.config[field]=value},function(){var Iam=corbel.Iam=function(driver){this.driver=driver};Iam.moduleName="iam",Iam.defaultPort=8082,Iam.create=function(driver){return new Iam(driver)},Iam.GRANT_TYPE="urn:ietf:params:oauth:grant-type:jwt-bearer",Iam.AUD="http://iam.bqws.io",Iam.IAM_TOKEN="iamToken",Iam.IAM_TOKEN_SCOPES="iamScopes",Iam.IAM_DOMAIN="domain",Iam._buildUri=function(uri,id){id&&(uri+="/"+id);var urlBase=this.driver.config.getCurrentEndpoint(Iam.moduleName,corbel.Iam._buildPort(this.driver.config));return urlBase+uri},Iam._buildUriWithDomain=function(uri,id){var urlBase=this.driver.config.getCurrentEndpoint(Iam.moduleName,corbel.Iam._buildPort(this.driver.config)),domain=this.driver.config.get(corbel.Iam.IAM_DOMAIN,"unauthenticated"),customDomain=this.driver.config.get(corbel.Domain.CUSTOM_DOMAIN,domain);this.driver.config.set(corbel.Domain.CUSTOM_DOMAIN,void 0);var uriWithDomain=urlBase+customDomain+"/"+uri;return id&&(uriWithDomain+="/"+id),uriWithDomain},Iam._buildPort=function(config){return config.get("iamPort",null)||corbel.Iam.defaultPort}}(),function(){corbel.Iam.prototype.client=function(clientId){var client=new ClientBuilder(clientId);return client.driver=this.driver,client};var ClientBuilder=corbel.Iam.ClientBuilder=corbel.Services.inherit({constructor:function(clientId){this.clientId=clientId,this.uri="client"},create:function(client){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.POST,data:client}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(){return corbel.validate.value("clientId",this.clientId),this.request({
url:this._buildUriWithDomain(this.uri,this.clientId),method:corbel.request.method.GET})},getAll:function(params){return corbel.validate.failIfIsDefined(this.clientId,"This function not allowed client identifier"),this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},update:function(client){return corbel.validate.value("clientId",this.clientId),this.request({url:this._buildUriWithDomain(this.uri+"/"+this.clientId),method:corbel.request.method.PUT,data:client})},remove:function(){return corbel.validate.value("clientId",this.clientId),this.request({url:this._buildUriWithDomain(this.uri+"/"+this.clientId),method:corbel.request.method.DELETE})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.domain=function(){var domain=new DomainBuilder;return domain.driver=this.driver,domain};var DomainBuilder=corbel.Iam.DomainBuilder=corbel.Services.inherit({constructor:function(){this.uri="domain"},create:function(domain){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.POST,data:domain}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.GET})},getAll:function(params){return this.request({url:this._buildUriWithDomain(this.uri+"/all"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},update:function(domain){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.PUT,data:domain})},remove:function(){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.DELETE})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.scope=function(id){var scope=new ScopeBuilder(id);return scope.driver=this.driver,scope};var ScopeBuilder=corbel.Iam.ScopeBuilder=corbel.Services.inherit({constructor:function(id){this.id=id,this.uri="scope"},create:function(scope){return corbel.validate.failIfIsDefined(this.id,"This function not allowed scope identifier"),this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.POST,data:scope}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri+"/"+this.id),method:corbel.request.method.GET})},remove:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri+"/"+this.id),method:corbel.request.method.DELETE})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.token=function(){var tokenBuilder=new TokenBuilder(this.driver);return tokenBuilder.driver=this.driver,tokenBuilder};var TokenBuilder=corbel.Iam.TokenBuilder=corbel.Services.inherit({constructor:function(){this.uri="oauth/token"},_buildUri:corbel.Iam._buildUri,_getJwt:function(params){if(params=params||{},params.claims=params.claims||{},params.jwt)return params.jwt;var secret=params.secret||this.driver.config.get("clientSecret");return params.claims.iss=params.claims.iss||this.driver.config.get("clientId"),params.claims.aud=params.claims.aud||this.driver.config.get("audience",corbel.Iam.AUD),params.claims.scope=params.claims.scope||this.driver.config.get("scopes",""),corbel.jwt.generate(params.claims,secret)},_doGetTokenRequest:function(uri,params,setCookie){var args={url:this._buildUri(uri),method:corbel.request.method.GET,query:corbel.utils.param(corbel.utils.extend({assertion:this._getJwt(params),grant_type:corbel.Iam.GRANT_TYPE},params.oauth)),withCredentials:!0};return setCookie&&(args.headers={RequestCookie:"true"}),corbel.request.send(args)},_doPostTokenRequest:function(uri,params,setCookie){var args={url:this._buildUri(uri),method:corbel.request.method.POST,data:{assertion:this._getJwt(params),grant_type:corbel.Iam.GRANT_TYPE},contentType:"application/x-www-form-urlencoded; charset=UTF-8",withCredentials:!0};return setCookie&&(args.headers={RequestCookie:"true"}),corbel.request.send(args,this.driver)},create:function(params,setCookie){params=params||{};var promise;try{params.oauth&&(promise=this._doGetTokenRequest(this.uri,params,setCookie)),promise=this._doPostTokenRequest(this.uri,params,setCookie)}catch(e){return Promise.reject(e)}var that=this;return promise.then(function(response){return that.driver.config.set(corbel.Iam.IAM_TOKEN,response.data),that.driver.config.set(corbel.Iam.IAM_DOMAIN,corbel.jwt.decode(response.data.accessToken).domainId),params.jwt&&that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,corbel.jwt.decode(params.jwt).scope),params.claims&&(params.claims.scope?that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,params.claims.scope):that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,that.driver.config.get("scopes",""))),response})},refresh:function(refreshToken,scopes){corbel.validate.isValue(refreshToken,"Refresh access token request must contains refresh token");var params={claims:{scope:scopes,refresh_token:refreshToken}},that=this;try{return this._doPostTokenRequest(this.uri,params).then(function(response){return that.driver.config.set(corbel.Iam.IAM_TOKEN,response.data),response})}catch(e){return Promise.reject(e)}}})}(),function(){corbel.Iam.prototype.username=function(){var username=new UsernameBuilder;return username.driver=this.driver,username};var UsernameBuilder=corbel.Iam.UsernameBuilder=corbel.Services.inherit({constructor:function(){this.uri="username"},availability:function(username){return corbel.validate.value("username",username),this.request({url:this._buildUriWithDomain(this.uri,username),method:corbel.request.method.HEAD}).then(function(){return!1})["catch"](function(response){return 404===response.status||Promise.reject(response)})},getUserId:function(username){return corbel.validate.value("username",username),this.request({url:this._buildUriWithDomain(this.uri,username),method:corbel.request.method.GET})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.user=function(id){var builder;return builder="me"===id?new UserBuilder("me"):id?new UserBuilder(id):new UserMeBuilder("me"),builder.driver=this.driver,builder},corbel.Iam.prototype.users=function(){var builder=new UsersBuilder;return builder.driver=this.driver,builder},corbel.Iam._getUser=function(method,uri,id,postfix){var url=postfix?this._buildUriWithDomain(uri,id)+postfix:this._buildUriWithDomain(uri,id);return this.request({url:url,method:corbel.request.method.GET})};var UserBuilder=(corbel.Iam.CommonUserBuilder=corbel.Services.inherit({constructor:function(id){this.uri="user",this.id=id},get:function(){return corbel.validate.value("id",this.id),this._getUser(corbel.request.method.GET,this.uri,this.id)},_update:function(data,options){corbel.validate.value("id",this.id);var args=corbel.utils.extend(options||{},{url:this._buildUriWithDomain(this.uri,this.id),method:corbel.request.method.PUT,data:data});return this.request(args)},_delete:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id),method:corbel.request.method.DELETE})},_signOut:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/signout",method:corbel.request.method.PUT})},_disconnect:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/disconnect",method:corbel.request.method.PUT})},_getSession:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/session",method:corbel.request.method.GET})},_closeSessions:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/session",method:corbel.request.method.DELETE})},addIdentity:function(identity){return corbel.validate.isValue(identity,"Missing identity"),corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/identity",method:corbel.request.method.POST,data:identity})},_getIdentities:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/identity",method:corbel.request.method.GET})},_registerDevice:function(deviceId,data){return corbel.validate.values(["id","deviceId"],{id:this.id,deviceId:deviceId}),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/device/"+deviceId,method:corbel.request.method.PUT,data:data}).then(function(res){return corbel.Services.getLocationId(res)})},_getDevice:function(deviceId){return corbel.validate.values(["id","deviceId"],{id:this.id,deviceId:deviceId}),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/device/"+deviceId,method:corbel.request.method.GET})},_getDevices:function(params){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/device",method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_deleteDevice:function(deviceId){return corbel.validate.values(["id","deviceId"],{id:this.id,deviceId:deviceId}),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/device/"+deviceId,method:corbel.request.method.DELETE})},_getProfile:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/profile",method:corbel.request.method.GET})},addGroups:function(groups){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/group",method:corbel.request.method.PUT,data:groups})},_deleteGroup:function(group){return corbel.validate.values(["id","group"],{id:this.id,group:group}),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/group/"+group,method:corbel.request.method.DELETE})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain,_getUser:corbel.Iam._getUser}),corbel.Iam.CommonUserBuilder.inherit({deleteGroup:function(){return this._deleteGroup.apply(this,arguments)},update:function(){return this._update.apply(this,arguments)},"delete":function(){return this._delete.apply(this,arguments)},registerDevice:function(){return this._registerDevice.apply(this,arguments)},getDevices:function(){return this._getDevices.apply(this,arguments)},getDevice:function(){return this._getDevice.apply(this,arguments)},deleteDevice:function(){return this._deleteDevice.apply(this,arguments)},signOut:function(){return this._signOut.apply(this,arguments)},disconnect:function(){return this._disconnect.apply(this,arguments)},closeSessions:function(){return this._closeSessions.apply(this,arguments)},getIdentities:function(){return this._getIdentities.apply(this,arguments)},getProfile:function(){return this._getProfile.apply(this,arguments)}})),UserMeBuilder=corbel.Iam.CommonUserBuilder.inherit({deleteMyGroup:function(){return this._deleteGroup.apply(this,arguments)},updateMe:function(){return this._update.apply(this,arguments)},deleteMe:function(){return this._delete.apply(this,arguments)},registerMyDevice:function(){return this._registerDevice.apply(this,arguments)},getMyDevices:function(){return this._getDevices.apply(this,arguments)},getMyDevice:function(){return this._getDevice.apply(this,arguments)},getMySession:function(){return this._getSession.apply(this,arguments)},deleteMyDevice:function(){return this._deleteDevice.apply(this,arguments)},signOutMe:function(){return this._signOut.apply(this,arguments)},disconnectMe:function(){return this._disconnect.apply(this,arguments)},closeSessionsMe:function(){return this._closeSessions.apply(this,arguments)},getMyIdentities:function(){return this._getIdentities.apply(this,arguments)},getMyProfile:function(){return this._getProfile.apply(this,arguments)}}),UsersBuilder=corbel.Iam.UsersBuilder=corbel.Services.inherit({constructor:function(){this.uri="user"},sendResetPasswordEmail:function(userEmailToReset){var query="email="+encodeURIComponent(userEmailToReset);return this.request({url:this._buildUriWithDomain(this.uri+"/resetPassword"),method:corbel.request.method.GET,query:query})},create:function(data){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.POST,data:data}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(params){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},getProfiles:function(params){return this.request({url:this._buildUriWithDomain(this.uri)+"/profile",method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.group=function(id){var builder;return builder=id?new GroupBuilder(id):new GroupsBuilder,builder.driver=this.driver,builder};var GroupsBuilder=corbel.Iam.GroupsBuilder=corbel.Services.inherit({constructor:function(){this.uri="group"},getAll:function(params){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null,withAuth:!0})},create:function(data){return this.request({url:this._buildUriWithDomain(this.uri),method:corbel.request.method.POST,data:data,withAuth:!0}).then(function(res){return corbel.Services.getLocationId(res)})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain}),GroupBuilder=corbel.Iam.GroupBuilder=corbel.Services.inherit({constructor:function(id){this.uri="group",this.id=id},get:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id),method:corbel.request.method.GET,withAuth:!0})},addScopes:function(scopes){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/scope",method:corbel.request.method.PUT,data:scopes,withAuth:!0})},removeScope:function(scope){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id)+"/scope/"+scope,method:corbel.request.method.DELETE,withAuth:!0})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUriWithDomain(this.uri,this.id),method:corbel.request.method.DELETE,withAuth:!0})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}(),function(){corbel.Iam.prototype.email=function(){var builder;return builder=new EmailBuilder,builder.driver=this.driver,builder};var EmailBuilder=corbel.Iam.EmailBuilder=corbel.Services.inherit({constructor:function(){this.uri="email"},getUserId:function(email){return corbel.validate.value("email",email),this.request({url:this._buildUriWithDomain(this.uri,email),method:corbel.request.method.GET})},availability:function(email){return corbel.validate.value("email",email),this.request({url:this._buildUriWithDomain(this.uri,email),method:corbel.request.method.HEAD}).then(function(){return!1},function(response){return 404===response.status||Promise.reject(response)})},_buildUriWithDomain:corbel.Iam._buildUriWithDomain})}();var aggregationBuilder=function(){var aggregationBuilder={};return aggregationBuilder.count=function(field){return this.params.aggregation=this.params.aggregation||{},this.params.aggregation.$count=field,this},aggregationBuilder}(),queryBuilder=function(){var queryBuilder={};return queryBuilder.eq=function(field,value){return this.addCriteria("$eq",field,value),this},queryBuilder.gt=function(field,value){return this.addCriteria("$gt",field,value),this},queryBuilder.gte=function(field,value){return this.addCriteria("$gte",field,value),this},queryBuilder.lt=function(field,value){return this.addCriteria("$lt",field,value),this},queryBuilder.lte=function(field,value){return this.addCriteria("$lte",field,value),this},queryBuilder.ne=function(field,value){return this.addCriteria("$ne",field,value),this},queryBuilder.like=function(field,value){return this.addCriteria("$like",field,value),this},queryBuilder["in"]=function(field,values){return this.addCriteria("$in",field,values),this},queryBuilder.all=function(field,values){return this.addCriteria("$all",field,values),this},queryBuilder.elemMatch=function(field,query){return this.addCriteria("$elem_match",field,query),this},queryBuilder.setQueryDomain=function(queryDomain){return this.params.queryDomain=queryDomain,this},queryBuilder.addCriteria=function(operator,field,value){var criteria={};return criteria[operator]={},criteria[operator][field]=value,this.params.query=this.params.query||[],this.params.query.push(criteria),this},queryBuilder}(),pageBuilder=function(){var pageBuilder={};return pageBuilder.page=function(page){return this.params.pagination=this.params.pagination||{},this.params.pagination.page=page,this},pageBuilder.pageSize=function(pageSize){return this.params.pagination=this.params.pagination||{},this.params.pagination.pageSize=pageSize,this},pageBuilder.pageParam=function(page,pageSize){return this.params.pagination=this.params.pagination||{},this.params.pagination.page=page,this.params.pagination.pageSize=pageSize,this},pageBuilder}(),sortBuilder=function(){var sortBuilder={};return sortBuilder.asc=function(field){return this.params.sort=this.params.sort||{},this.params.sort[field]=corbel.Resources.sort.ASC,this},sortBuilder.desc=function(field){return this.params.sort=this.params.sort||{},this.params.sort[field]=corbel.Resources.sort.DESC,this},sortBuilder}();return function(aggregationBuilder,queryBuilder,sortBuilder,pageBuilder){return corbel.requestParamsBuilder=corbel.Object.inherit({constructor:function(){this.params={}},build:function(){return this.params}}),corbel.utils.extend(corbel.requestParamsBuilder.prototype,queryBuilder,sortBuilder,aggregationBuilder,pageBuilder),corbel.requestParamsBuilder}(aggregationBuilder,queryBuilder,sortBuilder,pageBuilder),function(){return corbel.Assets=corbel.Object.inherit({constructor:function(driver){this.driver=driver},asset:function(id){return new corbel.Assets.AssetsBuilder(this.driver,id)}},{moduleName:"assets",defaultPort:8092,create:function(driver){return new corbel.Assets(driver)}}),corbel.Assets}(),function(){var AssetsBuilder=corbel.Assets.AssetsBuilder=corbel.Services.inherit({constructor:function(driver,id){this.driver=driver,this.uri="asset",this.id=id},get:function(params){var options=params?corbel.utils.clone(params):{},args=corbel.utils.extend(options,{url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null});return this.request(args)},getAll:function(params){var options=params?corbel.utils.clone(params):{},args=corbel.utils.extend(options,{url:this._buildUri(this.uri,"all"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null});return this.request(args)},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},create:function(data){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,data:data}).then(function(res){return corbel.Services.getLocationId(res)})},access:function(params){var args=params?corbel.utils.clone(params):{};args.url=this._buildUri(this.uri+"/access"),args.method=corbel.request.method.GET,args.noRedirect=!0;var that=this;return this.request(args).then(function(response){return that.request({noRetry:args.noRetry,method:corbel.request.method.POST,contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:response.data,url:response.headers.location})})},_buildUri:function(path,id){var uri="",urlBase=this.driver.config.getCurrentEndpoint(corbel.Assets.moduleName,this._buildPort(this.driver.config));return uri=urlBase+path,id&&(uri+="/"+id),uri},_buildPort:function(config){return config.get("assetsPort",null)||corbel.Assets.defaultPort}},{moduleName:"assets",create:function(driver){return new corbel.Assets.AssetsBuilder(driver)}});return AssetsBuilder}(),function(){return corbel.Scheduler=corbel.Object.inherit({constructor:function(driver){this.driver=driver},task:function(id){return new corbel.Scheduler.TaskBuilder(this.driver,id)}},{moduleName:"scheduler",defaultPort:8098,create:function(driver){return new corbel.Scheduler(driver)}}),corbel.Scheduler}(),function(){var TaskBuilder=corbel.Scheduler.TaskBuilder=corbel.Services.inherit({constructor:function(driver,id){this.uri="tasks",this.driver=driver,this.id=id},create:function(task){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,data:task}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(params){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},update:function(task){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.PUT,data:task})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},_buildUri:function(path,id){var uri="",urlBase=this.driver.config.getCurrentEndpoint(corbel.Scheduler.moduleName,this._buildPort(this.driver.config));return uri=urlBase+path,id&&(uri+="/"+id),uri},_buildPort:function(config){return config.get("schedulerPort",null)||corbel.Notifications.defaultPort}},{moduleName:"tasks",create:function(driver){return new corbel.TaskBuilder(driver)}});return TaskBuilder}(),function(){return corbel.Resources=corbel.Object.inherit({constructor:function(driver){this.driver=driver},collection:function(type){return new corbel.Resources.Collection(type,this.driver)},resource:function(type,id){return new corbel.Resources.Resource(type,id,this.driver)},relation:function(srcType,srcId,destType){return new corbel.Resources.Relation(srcType,srcId,destType,this.driver)}},{moduleName:"resources",defaultPort:8080,sort:{ASC:"asc",DESC:"desc"},ALL:"_",create:function(driver){return new corbel.Resources(driver)}}),corbel.Resources}(),function(){return corbel.Resources.BaseResource=corbel.Services.inherit({buildUri:function(srcType,srcId,destType,destId){var urlBase=this.driver.config.getCurrentEndpoint(corbel.Resources.moduleName,this._buildPort(this.driver.config)),domain=this.driver.config.get(corbel.Iam.IAM_DOMAIN,"unauthenticated"),customDomain=this.driver.config.get(corbel.Domain.CUSTOM_DOMAIN,domain);this.driver.config.set(corbel.Domain.CUSTOM_DOMAIN,void 0);var uri=urlBase+customDomain+"/resource/"+srcType;return srcId&&(uri+="/"+srcId,destType&&(uri+="/"+destType,destId&&(uri+=";r="+destType+"/"+destId))),uri},_buildPort:function(config){return config.get("resourcesPort",null)||corbel.Resources.defaultPort},request:function(args){var params=corbel.utils.extend(this.params,args);return this.params={},args.query=corbel.utils.serializeParams(params),corbel.Services.prototype.request.apply(this,[args].concat(Array.prototype.slice.call(arguments,1)))},getURL:function(params){return this.buildUri(this.type,this.srcId,this.destType)+(params?"?"+corbel.utils.serializeParams(params):"")},getDefaultOptions:function(options){var defaultOptions=options?corbel.utils.clone(options):{};return defaultOptions}}),corbel.utils.extend(corbel.Resources.BaseResource.prototype,corbel.requestParamsBuilder.prototype),corbel.Resources.BaseResource}(),function(){return corbel.Resources.Relation=corbel.Resources.BaseResource.inherit({constructor:function(srcType,srcId,destType,driver,params){this.type=srcType,this.srcId=srcId,this.destType=destType,corbel.validate.values(["type","srcId","destType"],this),this.driver=driver,this.params=params||{}},get:function(destId,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.srcId,this.destType,destId),method:corbel.request.method.GET,Accept:options.dataType});return this.request(args)},add:function(destId,relationData,options){options=this.getDefaultOptions(options),corbel.validate.value("destId",destId);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.srcId,this.destType,destId),data:relationData,method:corbel.request.method.PUT,contentType:options.dataType,Accept:options.dataType});return this.request(args)},addAnonymous:function(relationData,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.srcId,this.destType),data:relationData,method:corbel.request.method.POST,contentType:options.dataType,Accept:options.dataType});return this.request(args)},move:function(destId,pos,options){corbel.validate.value("destId",destId);var positionStartId=destId.indexOf("/");positionStartId!==-1&&(destId=destId.substring(positionStartId+1)),options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.srcId,this.destType,destId),contentType:"application/json",data:{_order:"$pos("+pos+")"},method:corbel.request.method.PUT});return this.request(args)},"delete":function(destId,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.srcId,this.destType,destId),method:corbel.request.method.DELETE,Accept:options.dataType});return this.request(args)}}),corbel.Resources.Relation}(),function(){return corbel.Resources.Collection=corbel.Resources.BaseResource.inherit({constructor:function(type,driver,params){this.type=type,corbel.validate.value("type",this.type),this.driver=driver,this.params=params||{}},get:function(options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type),method:corbel.request.method.GET,Accept:options.dataType});return this.request(args)},add:function(data,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type),method:corbel.request.method.POST,contentType:options.dataType,Accept:options.dataType,data:data});return this.request(args).then(function(res){return corbel.Services.getLocationId(res)})},update:function(data,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type),method:corbel.request.method.PUT,contentType:options.dataType,Accept:options.dataType,data:data});return this.request(args)},"delete":function(options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type),method:corbel.request.method.DELETE,contentType:options.dataType,Accept:options.dataType});return this.request(args)}}),corbel.Resources.Collection}(),function(){return corbel.Resources.Resource=corbel.Resources.BaseResource.inherit({constructor:function(type,id,driver,params){this.type=type,this.id=id,corbel.validate.values(["type","id"],this),this.driver=driver,this.params=params||{}},get:function(options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.id),method:corbel.request.method.GET,contentType:options.dataType,Accept:options.dataType});return this.request(args)},update:function(data,options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.id),method:corbel.request.method.PUT,data:data,contentType:options.dataType,Accept:options.dataType});return this.request(args)},updateAcl:function(acl){var args={url:this.buildUri(this.type,this.id),method:corbel.request.method.PUT,data:acl,Accept:"application/corbel.acl+json"};return this.request(args)},"delete":function(options){options=this.getDefaultOptions(options);var args=corbel.utils.extend(options,{url:this.buildUri(this.type,this.id),method:corbel.request.method.DELETE,contentType:options.dataType,Accept:options.dataType});return this.request(args)}}),corbel.Resources.Resource}(),function(){var Oauth=corbel.Oauth=function(driver){this.driver=driver};Oauth.moduleName="oauth",Oauth.defaultPort=8084,Oauth.create=function(driver){return new Oauth(driver)},Oauth._buildUri=function(uri){var urlBase=this.driver.config.getCurrentEndpoint(Oauth.moduleName,corbel.Oauth._buildPort(this.driver.config));return urlBase+uri},Oauth._buildPort=function(config){return config.get("oauthPort",null)||corbel.Oauth.defaultPort},Oauth._URL_ENCODED="application/x-www-form-urlencoded; charset=UTF-8",Oauth._checkProp=function(dict,keys,excep){var error=excep?excep:"Error validating arguments";if(!dict)throw new Error(error);for(var i in keys)if(!(keys[i]in dict))throw new Error(error)},Oauth._validateResponseType=function(responseType){if(["code","token"].indexOf(responseType)<0)throw new Error('Only "code" or "token" response type allowed')},Oauth._validateGrantType=function(grantType){if("authorization_code"!==grantType)throw new Error('Only "authorization_code" grant type is allowed')},Oauth._trasformParams=function(clientParams){for(var key in clientParams){var keyWithUnderscores=this._toUnderscore(key);key!==keyWithUnderscores&&(clientParams[keyWithUnderscores]=clientParams[key],delete clientParams[key])}return clientParams},Oauth._toUnderscore=function(string){return string.replace(/([A-Z])/g,function($1){return"_"+$1.toLowerCase()})}}(),function(){corbel.Oauth.prototype.authorization=function(clientParams){corbel.Oauth._checkProp(clientParams,["responseType"],"Invalid client parameters"),clientParams.responseType=clientParams.responseType.toLowerCase(),corbel.Oauth._validateResponseType(clientParams.responseType),"code"===clientParams.responseType.toLowerCase()&&corbel.Oauth._checkProp(clientParams,["redirectUri"],"Invalid client parameters"),clientParams.clientId=clientParams.clientId||corbel.Config.get("oauthClientId");var params={contentType:corbel.Oauth._URL_ENCODED,data:corbel.Oauth._trasformParams(clientParams),noRedirect:!0},authorization=new AuthorizationBuilder(params);return authorization.driver=this.driver,authorization};var AuthorizationBuilder=corbel.Oauth.AuthorizationBuilder=corbel.Services.inherit({constructor:function(params){this.params=params,this.uri="oauth"},loginWithCookie:function(){var that=this;return this.request({url:this._buildUri(this.uri+"/authorize"),method:corbel.request.method.GET,dataType:"text",withCredentials:!0,query:corbel.utils.toURLEncoded(this.params.data),noRedirect:!0,contentType:corbel.Oauth._URL_ENCODED}).then(function(res){var params={url:corbel.Services.getLocation(res),withCredentials:!0};return that.request(params)})},login:function(username,password,setCookie,redirect){username&&(this.params.data.username=username),password&&(this.params.data.password=password),this.params.withCredentials=!0;var that=this;return this.request({url:this._buildUri(this.uri+"/authorize"),method:corbel.request.method.POST,data:this.params.data,contentType:this.params.contentType,noRedirect:!redirect||redirect}).then(function(res){if(corbel.Services.getLocation(res)){var req={url:corbel.Services.getLocation(res)};return setCookie&&(req.headers={RequestCookie:"true"},req.withCredentials=!0),that.request(req).then(function(response){var accessToken=response.data.accessToken||response.data.query.code;return that.driver.config.set(corbel.Iam.IAM_TOKEN,response.data),that.driver.config.set(corbel.Iam.IAM_DOMAIN,corbel.jwt.decode(accessToken).domainId),that.params.jwt&&that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,corbel.jwt.decode(that.params.jwt).scope),that.params.claims&&(that.params.claims.scope?that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,that.params.claims.scope):that.driver.config.set(corbel.Iam.IAM_TOKEN_SCOPES,that.driver.config.get("scopes",""))),response})}return res.data})},signout:function(){return delete this.params.data,this.request({url:this._buildUri(this.uri+"/signout"),method:corbel.request.method.GET,
withCredentials:!0}).then(function(res){return corbel.Services.getLocationId(res)})},_buildUri:corbel.Oauth._buildUri})}(),function(){corbel.Oauth.prototype.token=function(clientParams){corbel.Oauth._checkProp(clientParams,["grantType"],"Invalid client parameters"),corbel.Oauth._validateGrantType(clientParams.grantType),clientParams.clientId=clientParams.clientId||corbel.Config.get("OAUTH_DEFAULT.clientId"),clientParams.clientSecret=clientParams.clientSecret||corbel.Config.get("OAUTH_DEFAULT.clientSecret");var params={contentType:corbel.Oauth._URL_ENCODED,data:corbel.Oauth._trasformParams(clientParams)},token=new TokenBuilder(params);return token.driver=this.driver,token};var TokenBuilder=corbel.Oauth.TokenBuilder=corbel.Services.inherit({constructor:function(params){this.params=params,this.uri="oauth/token"},get:function(code){return this.params.data.code=code,this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:this.params.data})},_buildUri:corbel.Oauth._buildUri})}(),function(){corbel.Oauth.prototype.user=function(clientParams,accessToken){var params={};accessToken&&(params.accessToken=accessToken,params.headers={},params.headers.Accept="application/json"),clientParams=clientParams||{};var clientId=clientParams.clientId||corbel.Config.get("oauthClientId"),clientSecret=clientParams.clientSecret||corbel.Config.get("oauthSecret"),user=new UserBuilder(params,clientId,clientSecret);return user.driver=this.driver,user};var UserBuilder=corbel.Oauth.UserBuilder=corbel.Services.inherit({constructor:function(params,clientId,clientSecret){this.params=params,this.clientSecret=clientSecret,this.clientId=clientId,this.uri="user"},_buildUri:corbel.Oauth._buildUri,create:function(user){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,headers:{Authorization:"Basic "+this.getSerializer()(this.clientId+":"+this.clientSecret)},dataType:"text",data:user}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(id){this.uri+="/"+id;var params=corbel.utils.extend(this.params,{});return params.method=corbel.request.method.GET,params.withAuth=!0,params.url=this._buildUri(this.uri),this.request(params)},getProfile:function(id){this.uri+="/"+id+"/profile";var params=corbel.utils.extend(this.params,{});return params.method=corbel.request.method.GET,params.url=this._buildUri(this.uri),this.request(params)},update:function(id,modification){this.uri+="/"+id;var params=corbel.utils.extend(this.params,{});return params.url=this._buildUri(this.uri),params.method=corbel.request.method.PUT,params.data=modification,this.request(params)},"delete":function(id){this.uri+="/"+id;var params=corbel.utils.extend(this.params,{});return params.url=this._buildUri(this.uri),params.method=corbel.request.method.DELETE,this.request(params)},sendResetPasswordEmail:function(userEmailToReset){return this.request({url:this._buildUri(this.uri+"/resetPassword"),method:corbel.request.method.GET,query:"email="+encodeURIComponent(userEmailToReset),headers:{Authorization:"Basic "+this.getSerializer()(this.clientId+":"+this.clientSecret)},noRetry:!0}).then(function(res){return corbel.Services.getLocationId(res)})},sendValidateEmail:function(id){this.uri+="/"+id+"/validate";var params=corbel.utils.extend(this.params,{});return params.url=this._buildUri(this.uri),params.method=corbel.request.method.GET,params.withAuth=!0,this.request(params)},emailConfirmation:function(id){this.uri+="/"+id+"/emailConfirmation";var params=corbel.utils.extend(this.params,{});return params.url=this._buildUri(this.uri,id),params.method=corbel.request.method.PUT,params.noRetry=!0,this.request(params)},username:function(name){var params=corbel.utils.extend(this.params,{});return params.url=this._buildUri("username/"+name),params.method=corbel.request.method.GET,this.request(params)},getSerializer:function(){return corbel.Config.isNode?require("btoa"):btoa}})}(),function(){return corbel.Notifications=corbel.Object.inherit({constructor:function(driver){this.driver=driver},template:function(id){return new corbel.Notifications.NotificationsTemplateBuilder(this.driver,id)},domain:function(){return new corbel.Notifications.NotificationsDomainBuilder(this.driver)},notification:function(){return new corbel.Notifications.NotificationsBuilder(this.driver)}},{moduleName:"notifications",defaultPort:8094,create:function(driver){return new corbel.Notifications(driver)}}),corbel.Notifications}(),function(){return corbel.Notifications.BaseNotifications=corbel.Services.inherit({buildUri:function(uri,id){var urlBase=this.driver.config.getCurrentEndpoint(corbel.Notifications.moduleName,this._buildPort(this.driver.config)),domain=this.driver.config.get(corbel.Iam.IAM_DOMAIN,"unauthenticated"),customDomain=this.driver.config.get(corbel.Domain.CUSTOM_DOMAIN,domain);this.driver.config.set(corbel.Domain.CUSTOM_DOMAIN,void 0);var uriWithDomain=urlBase+customDomain+"/"+uri;return id&&(uriWithDomain+="/"+id),uriWithDomain},_buildPort:function(config){return config.get("notificationsPort",null)||corbel.Notifications.defaultPort}}),corbel.Notifications.BaseNotifications}(),function(){var NotificationsBuilder=corbel.Notifications.NotificationsBuilder=corbel.Notifications.BaseNotifications.inherit({constructor:function(driver){this.driver=driver,this.uri="notification"},send:function(notification){return this.uri+="/send",this.request({url:this.buildUri(this.uri),method:corbel.request.method.POST,data:notification})}},{moduleName:"notifications",create:function(driver){return new corbel.NotificationsBuilder(driver)}});return NotificationsBuilder}(),function(){return corbel.Notifications.NotificationsTemplateBuilder=corbel.Notifications.BaseNotifications.inherit({constructor:function(driver,id){this.driver=driver,this.uri="notification",this.id=id},create:function(notification){return this.request({url:this.buildUri(this.uri),method:corbel.request.method.POST,data:notification}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(params){return this.request({url:this.buildUri(this.uri,this.id),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},update:function(data){return corbel.validate.value("id",this.id),this.request({url:this.buildUri(this.uri,this.id),method:corbel.request.method.PUT,data:data})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this.buildUri(this.uri,this.id),method:corbel.request.method.DELETE})}},{moduleName:"notifications",create:function(driver){return new corbel.NotificationsTemplateBuilder(driver)}}),corbel.Notifications.NotificationsTemplateBuilder}(),function(){var NotificationsDomainBuilder=corbel.Notifications.NotificationsDomainBuilder=corbel.Notifications.BaseNotifications.inherit({constructor:function(driver){this.driver=driver,this.uri="domain"},create:function(domain){return this.request({url:this.buildUri(this.uri),method:corbel.request.method.POST,data:domain}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(){return this.request({url:this.buildUri(this.uri),method:corbel.request.method.GET})},update:function(data){return this.request({url:this.buildUri(this.uri),method:corbel.request.method.PUT,data:data})},"delete":function(){return this.request({url:this.buildUri(this.uri),method:corbel.request.method.DELETE})}},{moduleName:"notifications",create:function(driver){return new corbel.NotificationsDomainBuilder(driver)}});return NotificationsDomainBuilder}(),function(){var Ec=corbel.Ec=function(driver){this.driver=driver};Ec.moduleName="ec",Ec.defaultPort=8088,Ec.create=function(driver){return new Ec(driver)},Ec._ec={purchaseStates:{IN_PROCESS:"IN_PROCESS",COMPLETED:"COMPLETED",FAILED:"FAILED",IN_PAYMENT:"IN_PAYMENT",CANCELLED:"CANCELLED"}},Ec._buildUri=function(uri,id,extra,userId){id&&(uri+="/"+id),extra&&(uri+=extra),userId&&(uri+="/user/"+userId);var urlBase=this.driver.config.getCurrentEndpoint(Ec.moduleName,corbel.Ec._buildPort(this.driver.config));return urlBase+uri},Ec._buildPort=function(config){return config.get("ecPort",null)||corbel.Ec.defaultPort}}(),function(){corbel.Ec.prototype.order=function(id){var order=new OrderBuilder(id);return order.driver=this.driver,order};var OrderBuilder=corbel.Ec.OrderBuilder=corbel.Services.inherit({constructor:function(id){id&&(this.id=id),this.uri="order"},get:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET})},update:function(order){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.PUT,data:order})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},prepare:function(couponIds){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"/prepare"),method:corbel.request.method.POST,data:couponIds})},checkout:function(data){return data.paymentMethodIds?data.paymentMethodIds.length?(corbel.validate.value("id",this.id),this.request({method:corbel.request.method.POST,url:this._buildUri(this.uri,this.id,"/checkout"),data:data}).then(function(res){return corbel.Services.getLocationId(res)})):Promise.reject(new Error("One payment method is needed at least")):Promise.reject(new Error("paymentMethodIds lists needed"))},_buildUri:corbel.Ec._buildUri})}(),function(){corbel.Ec.prototype.payment=function(){var payment=new PaymentBuilder;return payment.driver=this.driver,payment};var PaymentBuilder=corbel.Ec.PaymentBuilder=corbel.Services.inherit({constructor:function(){this.uri="payment"},get:function(params,userId){return this.request({url:this._buildUri(this.uri,null,null,userId),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},getAll:function(params){return this.request({url:this._buildUri(this.uri,"all"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUri:corbel.Ec._buildUri})}(),function(){corbel.Ec.prototype.paymentMethod=function(){var paymentMethod=new PaymentMethodBuilder;return paymentMethod.driver=this.driver,paymentMethod};var PaymentMethodBuilder=corbel.Ec.PaymentMethodBuilder=corbel.Services.inherit({constructor:function(){this.uri="paymentmethod"},get:function(userId){return this.request({url:this._buildUri(this.uri,null,null,userId),method:corbel.request.method.GET})},add:function(params,userId){return this.request({url:this._buildUri(this.uri,null,null,userId),method:corbel.request.method.POST,data:params}).then(function(res){return corbel.Services.getLocationId(res)})},update:function(params){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.PUT,data:params}).then(function(res){return corbel.Services.getLocationId(res)})},getById:function(id){return corbel.validate.value("id",id),this.request({url:this._buildUri(this.uri,id),method:corbel.request.method.GET})},"delete":function(id,userId){return corbel.validate.value("id",id),this.request({url:this._buildUri(this.uri,id,null,userId),method:corbel.request.method.DELETE})},_buildUri:corbel.Ec._buildUri})}(),function(){corbel.Ec.prototype.paymentPlan=function(id){var paymentPlan=new PaymentPlanBuilder(id);return paymentPlan.driver=this.driver,paymentPlan};var PaymentPlanBuilder=corbel.Ec.PaymentPlanBuilder=corbel.Services.inherit({constructor:function(id){this.id=id,this.uri="paymentplan"},get:function(userId){return this.request({url:this._buildUri(this.uri,this.id,null,userId),method:corbel.request.method.GET})},"delete":function(id){return corbel.validate.value("id",id),this.request({url:this._buildUri(this.uri,id),method:corbel.request.method.DELETE})},rescue:function(id){return corbel.validate.value("id",id),this.request({url:this._buildUri(this.uri,id,"/rescue"),method:corbel.request.method.PUT})},updatePaymentMethod:function(params,userId){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"/paymentmethod",userId),method:corbel.request.method.PUT,data:params})},getAll:function(params){return this.request({url:this._buildUri(this.uri,"all"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUri:corbel.Ec._buildUri})}(),function(){corbel.Ec.prototype.product=function(id){var product=new ProductBuilder(id);return product.driver=this.driver,product};var ProductBuilder=corbel.Ec.ProductBuilder=corbel.Services.inherit({constructor:function(id){id&&(this.id=id),this.uri="product"},create:function(product){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,data:product}).then(function(res){return corbel.Services.getLocationId(res)})},getAll:function(params){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},get:function(params){return this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},update:function(product){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.PUT,data:product})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},_buildUri:corbel.Ec._buildUri})}(),function(){corbel.Ec.prototype.purchase=function(){var purchase=new PurchaseBuilder;return purchase.driver=this.driver,purchase};var PurchaseBuilder=corbel.Ec.PurchaseBuilder=corbel.Services.inherit({constructor:function(){this.uri="purchase"},get:function(id){return corbel.validate.value("id",id),this.request({url:this._buildUri(this.uri,id),method:corbel.request.method.GET})},getAll:function(params,userId){return this.request({url:this._buildUri(this.uri,null,null,userId),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUri:corbel.Ec._buildUri})}(),function(){return corbel.Evci=corbel.Object.inherit({constructor:function(driver){this.driver=driver},event:function(type){return new corbel.Evci.EventBuilder(type,this.driver)}},{moduleName:"evci",defaultPort:8086,create:function(driver){return new corbel.Evci(driver)}}),corbel.Evci}(),function(){var EventBuilder=corbel.Evci.EventBuilder=corbel.Services.inherit({constructor:function(type,driver){this.uri="event",this.eventType=type,this.driver=driver},publish:function(eventData){if(!eventData)throw new Error("Send event require data");return corbel.validate.value("eventType",this.eventType),this.request({url:this._buildUri(this.uri,this.eventType),method:corbel.request.method.POST,data:eventData}).then(function(res){return res})},_buildUri:function(path,eventType){var uri="",urlBase=this.driver.config.getCurrentEndpoint(corbel.Evci.moduleName,this._buildPort(this.driver.config));return uri=urlBase+path,eventType&&(uri+="/"+eventType),uri},_buildPort:function(config){return config.get("evciPort",null)||corbel.Evci.defaultPort}},{moduleName:"evci",create:function(driver){return new corbel.EventBuilder(driver)}});return EventBuilder}(),function(){return corbel.Borrow=corbel.Object.inherit({constructor:function(driver){this.driver=driver},resource:function(id){var resource=new corbel.Borrow.BorrowBuilder(id);return resource.driver=this.driver,resource},lender:function(id){var lender=new corbel.Borrow.LenderBuilder(id);return lender.driver=this.driver,lender},user:function(id){var user=new corbel.Borrow.UserBuilder(id);return user.driver=this.driver,user}},{moduleName:"borrow",defaultPort:8100,create:function(driver){return new corbel.Borrow(driver)},_buildUri:function(){var uri="";Array.prototype.slice.call(arguments).forEach(function(argument){argument&&(uri+="/"+argument)});var urlBase=this.driver.config.getCurrentEndpoint(corbel.Borrow.moduleName,corbel.Borrow._buildPort(this.driver.config));return"/"===urlBase.slice(-1)&&(urlBase=urlBase.substring(0,urlBase.length-1)),urlBase+uri},_buildPort:function(config){return config.get("borrowPort",null)||corbel.Borrow.defaultPort}}),corbel.Borrow}(),function(){corbel.Borrow.BorrowBuilder=corbel.Services.inherit({constructor:function(id){this.id=id,this.uri="resource"},add:function(loanableResource){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,data:loanableResource}).then(function(res){return corbel.Services.getLocationId(res)})},get:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},addLicense:function(license){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"license"),method:corbel.request.method.POST,data:license}).then(function(res){return corbel.Services.getLocationId(res)})},applyFor:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"loan/"+userId),method:corbel.request.method.PUT})},applyForMe:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"loan/me"),method:corbel.request.method.PUT})},getLentOf:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"loan/"+userId),method:corbel.request.method.GET})},getMyLent:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"loan/me"),method:corbel.request.method.GET})},returnLoanOf:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"loan/"+userId),method:corbel.request.method.DELETE})},returnMyLoan:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"loan/me"),method:corbel.request.method.DELETE})},renewFor:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"renewal/"+userId),method:corbel.request.method.PUT})},renewForMe:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"renewal/me"),method:corbel.request.method.PUT})},reserveFor:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"reservation/"+userId),method:corbel.request.method.PUT})},reserveForMe:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"reservation/me"),method:corbel.request.method.PUT})},cancelReservationFor:function(userId){return corbel.validate.values(["id","userId"],{id:this.id,userId:userId}),this.request({url:this._buildUri(this.uri,this.id,"reservation/"+userId),method:corbel.request.method.DELETE})},cancelMyReservation:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri(this.uri,this.id,"reservation/me"),method:corbel.request.method.DELETE})},getHistoryOf:function(userId){return corbel.validate.value("userId",userId),this.request({url:this._buildUri(this.uri,"history/"+userId),method:corbel.request.method.GET})},getMyHistory:function(){return this.request({url:this._buildUri(this.uri,"history/me"),method:corbel.request.method.GET})},getFullHistory:function(params){return this.request({url:this._buildUri(this.uri,"history/"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUri:corbel.Borrow._buildUri})}(),function(){corbel.Borrow.UserBuilder=corbel.Services.inherit({constructor:function(id){this.id=id||"me",this.uri="user"},getAllReservations:function(){return this.request({url:this._buildUri(this.uri,this.id,"reservation"),method:corbel.request.method.GET})},getAllLoans:function(){return this.request({url:this._buildUri(this.uri,this.id,"loan"),method:corbel.request.method.GET})},_buildUri:corbel.Borrow._buildUri})}(),function(){corbel.Borrow.LenderBuilder=corbel.Services.inherit({constructor:function(id){this.id=id,this.uri="lender"},create:function(lender){return this.request({url:this._buildUri(this.uri),method:corbel.request.method.POST,data:lender}).then(function(res){return corbel.Services.getLocationId(res)})},update:function(lender){return this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.PUT,data:lender})},"delete":function(){return this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.DELETE})},get:function(){return this.request({url:this._buildUri(this.uri,this.id),method:corbel.request.method.GET})},getAll:function(params){return this.request({url:this._buildUri(this.uri,"all"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},getAllReservations:function(params){return this.request({url:this._buildUri(this.uri,"reservation"),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null})},_buildUri:corbel.Borrow._buildUri})}(),function(){return corbel.CompoSR=corbel.Object.inherit({constructor:function(driver){this.driver=driver},phrase:function(id){var phraseBuilder=new corbel.CompoSR.PhraseBuilder(id);return phraseBuilder.driver=this.driver,phraseBuilder},request:function(){var requestBuilder=new corbel.CompoSR.RequestBuilder(Array.prototype.slice.call(arguments));return requestBuilder.driver=this.driver,requestBuilder}},{moduleName:"composr",defaultPort:3e3,create:function(driver){return new corbel.CompoSR(driver)},_buildPort:function(config){return config.get("composrPort",null)||corbel.CompoSR.defaultPort},_buildUri:function(){var urlBase=this.driver.config.getCurrentEndpoint(corbel.CompoSR.moduleName,corbel.CompoSR._buildPort(this.driver.config));"/"===urlBase.slice(-1)&&(urlBase=urlBase.substring(0,urlBase.length-1));var uri="";return Array.prototype.slice.call(arguments).forEach(function(argument){argument&&(uri+="/"+argument)}),urlBase+uri}}),corbel.CompoSR}(),function(){corbel.CompoSR.PhraseBuilder=corbel.Services.inherit({constructor:function(id){this.id=id},put:function(body){return this.request({url:this._buildUri("phrase",this.id),method:corbel.request.method.PUT,data:body})},get:function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri("phrase",this.id),method:corbel.request.method.GET})},getAll:function(){return this.request({url:this._buildUri("phrase"),method:corbel.request.method.GET})},"delete":function(){return corbel.validate.value("id",this.id),this.request({url:this._buildUri("phrase",this.id),method:corbel.request.method.DELETE})},_buildUri:corbel.CompoSR._buildUri})}(),function(){corbel.CompoSR.RequestBuilder=corbel.Services.inherit({constructor:function(pathsArray){this.path=this.buildPath(pathsArray)},post:function(data,options){return this.options=options||{},this.request({url:this._buildUri(this.path),method:corbel.request.method.POST,headers:this.options.headers,data:data,query:this.buildQueryPath(this.options.queryParams)})},get:function(options){return this.options=options||{},this.request({url:this._buildUri(this.path),method:corbel.request.method.GET,headers:this.options.headers,query:this.buildQueryPath(this.options.queryParams)})},put:function(data,options){return this.options=options||{},this.request({url:this._buildUri(this.path),method:corbel.request.method.PUT,data:data,headers:this.options.headers,query:this.buildQueryPath(this.options.queryParams)})},"delete":function(options){return this.options=options||{},this.request({url:this._buildUri(this.path),method:corbel.request.method.DELETE,headers:this.options.headers,query:this.buildQueryPath(this.options.queryParams)})},buildPath:function(pathArray){var path="";return path+=pathArray.shift(),pathArray.forEach(function(entryPath){path+="/"+entryPath}),path},buildQueryPath:function(dict){var query="";if(dict){var queries=[];Object.keys(dict).forEach(function(key){queries.push(key+"="+dict[key])}),queries.length>0&&(query=queries.join("&"))}return query},_buildUri:corbel.CompoSR._buildUri})}(),function(){return corbel.Webfs=corbel.Object.inherit({constructor:function(driver){this.driver=driver},webfs:function(id){return new corbel.Webfs.WebfsBuilder(this.driver,id)}},{moduleName:"webfs",defaultPort:8096,defaultDomain:"unauthenticated",domain:"domain",create:function(driver){return new corbel.Webfs(driver)}}),corbel.Webfs}(),function(){var WebfsBuilder=corbel.Webfs.WebfsBuilder=corbel.Services.inherit({constructor:function(driver,id){this.driver=driver,this.id=id},get:function(params){corbel.validate.value("id",this.id);var options=params?corbel.utils.clone(params):{},args=corbel.utils.extend(options,{url:this._buildUriWithDomain(this.id),method:corbel.request.method.GET,query:params?corbel.utils.serializeParams(params):null});return this.request(args)},"delete":function(){corbel.validate.value("id",this.id);var args={url:this._buildUriWithDomain(this.id),method:corbel.request.method.DELETE};return this.request(args)},_buildUri:function(id){var urlBase=this.driver.config.getCurrentEndpoint(corbel.Webfs.moduleName,this._buildPort(this.driver.config));return urlBase+id},_buildUriWithDomain:function(id){var urlBase=this.driver.config.getCurrentEndpoint(corbel.Webfs.moduleName,this._buildPort(this.driver.config)),domain=this.driver.config.get(corbel.Webfs.domain,corbel.Webfs.defaultDomain),customDomain=this.driver.config.get(corbel.Domain.CUSTOM_DOMAIN,domain);this.driver.config.set(corbel.Domain.CUSTOM_DOMAIN,void 0);var uriWithDomain=urlBase+customDomain+"/path";return id&&(uriWithDomain+="/"+id),uriWithDomain},_buildPort:function(config){return config.get("webfsPort",null)||corbel.Webfs.defaultPort}},{moduleName:"webfs",create:function(driver){return new corbel.Webfs.WebfsBuilder(driver)}});return WebfsBuilder}(),function(){return corbel.Domain=corbel.Object.inherit({constructor:function(driver){return this.driver=driver,function(id){return driver.config.set(corbel.Domain.CUSTOM_DOMAIN,id),driver}}},{moduleName:"domain",CUSTOM_DOMAIN:"customDomain",create:function(driver){return new corbel.Domain(driver)}}),corbel.Domain}(),corbel});